<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clonador de Sites com Proxy</title>
<style>
body { font-family: sans-serif; margin: 20px; }
input, button { margin: 5px 0; width: 100%; padding: 8px; }
textarea { width: 100%; height: 300px; margin-top: 10px; }
a { color: blue; cursor: pointer; text-decoration: underline; }
</style>
</head>
<body>

<h2>Clonador de Sites com Proxy</h2>

<label>URL do site:</label>
<input id="siteUrl" placeholder="https://example.com">

<label>Reposit√≥rio GitHub (usuario/repo):</label>
<input id="repo" placeholder="usuario/repositorio">

<label>Token (Fine-Grained)</label>
<input id="token" type="password" placeholder="github_pat_...">

<label>Branch (default: gh-pages)</label>
<input id="branch" placeholder="gh-pages">

<label>Profundidade de p√°ginas internas (ex: 1)</label>
<input id="depth" type="number" value="1">

<button id="tutorialLink">Como gerar token</button>
<button id="cloneBtn">Clonar e enviar</button>

<textarea id="log" readonly></textarea>

<script>
const logBox = document.getElementById("log");
function log(msg) {
  console.log(msg);
  logBox.textContent += msg + "\n";
  logBox.scrollTop = logBox.scrollHeight;
}

// Tutorial de token
document.getElementById("tutorialLink").onclick = (e) => {
  e.preventDefault();
  alert(`
üß© COMO GERAR UM FINE-GRAINED TOKEN NO GITHUB

1Ô∏è‚É£ Acesse: https://github.com/settings/personal-access-tokens
2Ô∏è‚É£ Clique em "Fine-grained tokens" > "Generate new token"
3Ô∏è‚É£ D√™ um nome (ex: "CloneSite")
4Ô∏è‚É£ Em "Repository access": escolha "Only select repositories" e selecione o reposit√≥rio alvo
5Ô∏è‚É£ Em "Permissions":
    ‚úÖ Contents ‚Üí Read and Write
    ‚úÖ Metadata ‚Üí Read-only
6Ô∏è‚É£ Clique em "Generate token"
7Ô∏è‚É£ Copie o token (come√ßa com "github_pat_...")

‚ö†Ô∏è Guarde-o com seguran√ßa!
`);
};

// ---------------- FETCH COM PROXY ----------------
const cache = {};
const proxy = "https://api.allorigins.win/get?url=";

async function fetchWithProxy(url) {
  if (cache[url]) return cache[url];
  try {
    log(`üåê Buscando via proxy: ${url}`);
    const res = await fetch(proxy + encodeURIComponent(url));
    if (!res.ok) throw new Error("Falha no proxy");
    const data = await res.json();
    cache[url] = data.contents;
    return data.contents;
  } catch (err) {
    log(`‚ùå Falha ao buscar ${url}: ${err.message}`);
    return "";
  }
}

// ---------------- FETCH RECURSIVO ----------------
async function fetchSite(url, maxDepth = 1, depth = 0, collected = {}, originDomain = null) {
  if (depth > maxDepth || collected[url]) return collected;
  try {
    log(`üì• Baixando: ${url}`);
    const html = await fetchWithProxy(url);
    const path = new URL(url).pathname === "/" ? "index.html" : new URL(url).pathname.slice(1);
    collected[url] = { content: html, path: path || "index.html" };

    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");

    if (!originDomain) originDomain = new URL(url).origin;

    // ----------------- BAIXA ASSETS -----------------
    const assets = [...doc.querySelectorAll("img[src],audio[src],script[src],link[rel='stylesheet'][href]")];
    for (const el of assets) {
      const attr = el.getAttribute("src") || el.getAttribute("href");
      if (!attr) continue;
      const abs = new URL(attr, url).href;
      if (!collected[abs]) {
        try {
          log(`üì¶ Baixando asset: ${abs}`);
          const assetContent = await fetchWithProxy(abs);
          collected[abs] = {
            content: btoa(unescape(encodeURIComponent(assetContent))),
            path: new URL(abs).pathname.slice(1) || "asset",
            binary: false
          };
        } catch {
          log(`‚ö†Ô∏è Falha ao baixar asset: ${abs}`);
        }
      }
    }

    // ----------------- LINKS INTERNOS -----------------
    const links = [...doc.querySelectorAll("a[href]")];
    for (const link of links) {
      let href = link.getAttribute("href");
      if (!href) continue;
      const abs = new URL(href, url).href;
      if (abs.startsWith(originDomain) && !collected[abs]) {
        await fetchSite(abs, maxDepth, depth + 1, collected, originDomain);
      }
    }

  } catch (err) {
    log(`‚ùå Erro ao baixar ${url}: ${err.message}`);
  }
  return collected;
}

// ---------------- UPLOAD PARA GITHUB ----------------
async function uploadToGitHub(repo, branch, token, files) {
  const api = `https://api.github.com/repos/${repo}`;
  const headers = {
    "Authorization": `Bearer ${token}`,
    "Accept": "application/vnd.github+json"
  };

  log(`üöÄ Enviando arquivos para ${repo}:${branch}`);

  // Cria branch se n√£o existir
  const mainRef = await fetch(`${api}/git/ref/heads/main`, { headers });
  const base = await mainRef.json();
  if (base && base.object) {
    await fetch(`${api}/git/refs`, {
      method: "POST",
      headers,
      body: JSON.stringify({ ref: `refs/heads/${branch}`, sha: base.object.sha })
    }).catch(() => {});
  }

  for (const f of Object.values(files)) {
    await fetch(`${api}/contents/${f.path}`, {
      method: "PUT",
      headers,
      body: JSON.stringify({
        message: `Adicionar ${f.path}`,
        content: f.content,
        branch
      })
    });
  }

  log("‚úÖ Upload conclu√≠do!");
  log(`üåê Ative o GitHub Pages em Settings ‚Üí Pages ‚Üí Branch: ${branch}`);
}

// ---------------- BOT√ÉO CLONAR ----------------
document.getElementById("cloneBtn").onclick = async () => {
  const siteUrl = document.getElementById("siteUrl").value.trim();
  const repo = document.getElementById("repo").value.trim();
  const token = document.getElementById("token").value.trim();
  const branch = document.getElementById("branch").value.trim() || "gh-pages";
  const depth = parseInt(document.getElementById("depth").value) || 1;

  if (!siteUrl || !repo || !token) {
    alert("Preencha todos os campos!");
    return;
  }

  log("üîç Iniciando clonagem via proxy...");
  const files = await fetchSite(siteUrl, depth);

  log("üì§ Enviando para o GitHub...");
  await uploadToGitHub(repo, branch, token, files);

  log("üéâ Pronto! Ative o GitHub Pages para visualizar o site clonado.");
};
</script>

</body>
</html>
